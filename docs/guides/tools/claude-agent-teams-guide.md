# Claude Code エージェントチーム ガイド

## このドキュメントの役割

このドキュメントは「**Claude Code のエージェントチーム（Agent Teams）機能**」を説明します。複数の Claude Code セッションを協調させて並列作業を行いたいときに参照してください。

> エージェントチームは**実験的機能**であり、デフォルトでは無効です。

**関連ドキュメント**:
- [Claude Skills 完全ガイド](./claude-skills-guide.md): スキルの構築方法
- [Agent Teams 公式ドキュメント](https://docs.anthropic.com/en/docs/claude-code/agent-teams): Anthropic 公式リファレンス
- [Subagents 公式ドキュメント](https://docs.anthropic.com/en/docs/claude-code/sub-agents): サブエージェントの詳細

## 目次

- [概要](#概要)
  - [エージェントチームが効果的な場面](#エージェントチームが効果的な場面)
  - [エージェントチームが向かない場面](#エージェントチームが向かない場面)
- [サブエージェントとの違い](#サブエージェントとの違い)
- [エージェントチームの有効化](#エージェントチームの有効化)
- [チームの作成](#チームの作成)
  - [自然言語でチームを構成する](#自然言語でチームを構成する)
  - [チームメイト数とモデルの指定](#チームメイト数とモデルの指定)
- [チームの操作](#チームの操作)
  - [表示モード](#表示モード)
  - [チームメイトへの直接操作](#チームメイトへの直接操作)
  - [デリゲートモード](#デリゲートモード)
  - [プラン承認の要求](#プラン承認の要求)
- [タスク管理](#タスク管理)
  - [タスクの割り当てとセルフクレーム](#タスクの割り当てとセルフクレーム)
  - [タスクの依存関係](#タスクの依存関係)
- [チームメイト間の通信](#チームメイト間の通信)
- [フックによる品質管理](#フックによる品質管理)
  - [TeammateIdle フック](#teammateidle-フック)
  - [TaskCompleted フック](#taskcompleted-フック)
- [ベストプラクティス](#ベストプラクティス)
- [トラブルシューティング](#トラブルシューティング)
- [制限事項](#制限事項)
- [まとめ](#まとめ)
- [参考リンク](#参考リンク)

## 概要

**エージェントチーム**は、複数の Claude Code インスタンスを協調させる機能です。1 つのセッションが**リード（Team Lead）**として機能し、他のセッションが**チームメイト（Teammates）**として独立して動作します。

チームの構成要素は以下の通りです：

| 構成要素 | 役割 |
| :--- | :--- |
| **リード** | チームを作成し、チームメイトを生成して作業を調整するメインセッション |
| **チームメイト** | それぞれ割り当てられたタスクに取り組む独立した Claude Code インスタンス |
| **タスクリスト** | チームメイトがクレーム（取得）して完了させる共有の作業一覧 |
| **メールボックス** | エージェント間の通信に使うメッセージングシステム |

### エージェントチームが効果的な場面

- **リサーチとレビュー**: 複数のチームメイトが問題の異なる側面を同時に調査し、互いの発見を共有・検証する
- **新機能の並列開発**: チームメイトがそれぞれ独立したモジュールを担当し、並列で実装する
- **競合仮説によるデバッグ**: 異なる理論を並列でテストし、議論を通じて根本原因を特定する
- **クロスレイヤー対応**: フロントエンド・バックエンド・テストの変更を、それぞれ異なるチームメイトが担当する

### エージェントチームが向かない場面

エージェントチームは調整オーバーヘッドがあり、単一セッションよりも大幅に多くのトークンを消費します。以下の場合は単一セッションまたはサブエージェントの方が効果的です：

- 順次的なタスク（前のタスクの完了を待つ必要がある）
- 同一ファイルの編集（競合が発生する）
- 依存関係が多い作業

## サブエージェントとの違い

エージェントチームとサブエージェントはどちらも作業を並列化できますが、動作が異なります。**チームメイト同士が通信する必要があるかどうか**が選択の判断基準です。

| | サブエージェント | エージェントチーム |
| :--- | :--- | :--- |
| **コンテキスト** | 独自のコンテキストウィンドウ。結果は呼び出し元に返される | 独自のコンテキストウィンドウ。完全に独立 |
| **通信** | メインエージェントにのみ結果を報告 | チームメイト同士が直接メッセージング |
| **調整** | メインエージェントがすべての作業を管理 | 共有タスクリストによる自己調整 |
| **最適な用途** | 結果だけが必要なフォーカスされたタスク | 議論や協力が必要な複雑な作業 |
| **トークンコスト** | 低い：結果がメインコンテキストに要約される | 高い：各チームメイトが独立した Claude インスタンス |

**判断基準**: 結果だけが必要ならサブエージェント、チームメイト同士が発見を共有し、互いに検証し合う必要があるならエージェントチームを使用します。

## エージェントチームの有効化

エージェントチームはデフォルトで無効です。環境変数 `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` を `1` に設定して有効化します。

### settings.json で設定する場合

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### シェル環境で直接設定する場合

```bash
export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
```

## チームの作成

### 自然言語でチームを構成する

エージェントチームを有効化したら、自然言語でチームの構成と役割を指示します。Claude がチームを作成し、チームメイトを生成して作業を調整します。

```
CLI ツールの設計を検討してください。3人のチームメイトを作成してください：
- UX 担当
- 技術アーキテクチャ担当
- 反論（Devil's Advocate）担当
```

チーム作成には 2 つのパターンがあります：

1. **明示的な要求**: チーム作成を直接指示する
2. **Claude からの提案**: タスクが並列作業に適していると判断した場合、Claude がチーム作成を提案する（確認後に作成）

どちらの場合でも、ユーザーの承認なしにチームが作成されることはありません。

### チームメイト数とモデルの指定

チームメイト数やモデルを明示的に指定することもできます：

```
4人のチームメイトを作成してモジュール全体のリファクタリングを並列実行してください。
各チームメイトに Sonnet を使用してください。
```

## チームの操作

### 表示モード

エージェントチームは 2 つの表示モードをサポートしています：

#### In-process モード

- すべてのチームメイトがメインターミナル内で動作する
- `Shift+Up/Down` でチームメイトを選択してメッセージ送信
- 追加セットアップ不要、任意のターミナルで動作する

#### Split panes モード

- 各チームメイトが独立したペインで表示される
- 全チームメイトの出力を同時に確認可能
- **tmux** または **iTerm2**（`it2` CLI）が必要

デフォルトは `"auto"` で、tmux セッション内で実行している場合は split panes、それ以外は in-process が選択されます。

```json
{
  "teammateMode": "in-process"
}
```

単一セッションのみ変更する場合はフラグを使用します：

```bash
claude --teammate-mode in-process
```

### チームメイトへの直接操作

各チームメイトは完全に独立した Claude Code セッションです。直接メッセージを送って追加指示や質問ができます。

**In-process モードの操作**:

| キー | 操作 |
| :--- | :--- |
| `Shift+Up/Down` | チームメイトを選択 |
| `Enter` | 選択中のチームメイトのセッションを表示 |
| `Escape` | 現在のターンを中断 |
| `Ctrl+T` | タスクリストの表示/非表示 |

**Split panes モードの操作**:
- チームメイトのペインをクリックして直接操作

### デリゲートモード

通常、リードはタスクを自分で実装し始めることがあります。**デリゲートモード**は、リードを調整専任に制限し、チームメイトの生成・メッセージング・タスク管理のみに限定します。

リードがコードに直接触れず、オーケストレーションに集中させたい場合に有効です。

**有効化**: チーム開始後に `Shift+Tab` を押してデリゲートモードに切り替え

### プラン承認の要求

複雑またはリスクのあるタスクでは、チームメイトに実装前の計画立案を要求できます。チームメイトは読み取り専用のプランモードで動作し、リードが承認するまで実装を開始しません。

```
認証モジュールをリファクタリングするアーキテクトチームメイトを作成してください。
変更を加える前にプラン承認を必須にしてください。
```

リードは自律的に承認を判断します。判断基準に影響を与えるには、プロンプトで条件を指定します：

```
テストカバレッジを含む計画のみ承認してください。
データベーススキーマを変更する計画は却下してください。
```

## タスク管理

共有タスクリストがチーム全体の作業を調整します。タスクには 3 つの状態があります：

- **pending**: 保留中（未着手）
- **in progress**: 進行中
- **completed**: 完了

### タスクの割り当てとセルフクレーム

タスクの割り当て方法は 2 つあります：

1. **リードが明示的に割り当て**: どのタスクをどのチームメイトに渡すか指定する
2. **セルフクレーム**: チームメイトがタスク完了後、次の未割り当て・ブロックされていないタスクを自動的に取得する

タスクのクレームにはファイルロックが使用され、複数のチームメイトが同時に同じタスクをクレームする競合を防止します。

### タスクの依存関係

タスクは他のタスクへの依存関係を持つことができます。依存先のタスクが完了するまで、そのタスクはブロックされクレームできません。依存タスクが完了すると自動的にブロックが解除されます。

## チームメイト間の通信

チームメイトはメッセージングシステムを通じて直接通信できます。

### メッセージの種類

- **個別メッセージ**: 特定のチームメイトにメッセージを送信

  ```
  researcher チームメイトに「調査結果を要約してください」とメッセージしてください
  ```

- **ブロードキャスト**: 全チームメイトに同時送信（チームサイズに応じてコストが増加するため控えめに使用）

  ```
  全チームメイトに最新の要件を共有してください
  ```

### 自動通知

- チームメイトがメッセージを送信すると、受信者に自動配信される（リードがポーリングする必要なし）
- チームメイトが完了して停止すると、リードに自動通知される

## フックによる品質管理

フックを使ってチームメイトの作業に品質ゲートを設けることができます。

### TeammateIdle フック

チームメイトがアイドル状態になる前に実行されます。終了コード `2` で返すと、フィードバックをチームメイトに送信して作業を継続させます。

```json
{
  "hooks": {
    "TeammateIdle": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "./scripts/quality-gate.sh"
          }
        ]
      }
    ]
  }
}
```

### TaskCompleted フック

タスクが完了としてマークされる際に実行されます。終了コード `2` で完了をブロックし、フィードバックを返します。

```bash
#!/bin/bash
# テストが通るまでタスク完了をブロックする例
if ! npm test 2>&1; then
  echo "テストをパスしてからタスクを完了してください" >&2
  exit 2
fi
exit 0
```

## ベストプラクティス

### 十分な初期コンテキストを提供する

チームメイトはプロジェクトコンテキスト（CLAUDE.md、MCP サーバー、スキル）を自動的に読み込みますが、**リードの会話履歴は引き継がれません**。タスク固有の情報はスポーンプロンプトに含めます：

```
セキュリティレビュアーチームメイトを作成してください。プロンプト:
「src/auth/ の認証モジュールをセキュリティ脆弱性の観点でレビューしてください。
トークン処理、セッション管理、入力バリデーションに注目してください。
アプリは httpOnly Cookie に保存された JWT トークンを使用しています。」
```

### タスク粒度を適切にする

- **小さすぎる**: 調整オーバーヘッドがメリットを上回る
- **大きすぎる**: チェックインなしで長時間作業し、無駄な作業が発生するリスク
- **適切**: 関数、テストファイル、レビューなど自己完結した単位

チームメイト 1 人あたり **5〜6 タスク**が目安です。

### ファイル競合を回避する

2 人のチームメイトが同じファイルを編集すると上書きが発生します。各チームメイトが異なるファイルセットを担当するように作業を分割します。

```
✗ チームメイト A と B が両方 src/auth.ts を編集
✓ チームメイト A が src/frontend/ を担当、チームメイト B が src/backend/ を担当
```

### リサーチとレビューから始める

エージェントチームに慣れていない場合は、コード変更を伴わないタスク（PR レビュー、ライブラリ調査、バグ調査）から始めるのがおすすめです。並列実装よりも調整が簡単で、並列作業の価値を実感できます。

### 定期的にモニタリングする

チームメイトの進捗を確認し、うまくいっていないアプローチを修正指示します。チームを長時間放置すると無駄な作業が発生するリスクが高まります。

```
チームメイトの進捗を確認してください
```

### チームメイトの完了を待つ

リードが自分でタスクを実装し始める場合は、以下のように指示します：

```
チームメイトがタスクを完了するまで待ってください
```

## トラブルシューティング

### チームメイトが表示されない

- In-process モードでは、`Shift+Down` でアクティブなチームメイトを巡回できる
- タスクがチーム作成を必要とするほど複雑かどうか、Claude が判断している可能性がある
- Split panes モードでは tmux がインストールされ PATH に含まれているか確認する：
  ```bash
  which tmux
  ```

### パーミッションプロンプトが多すぎる

チームメイトのパーミッション要求はリードに伝播します。チームメイトを生成する前に、よく使う操作をパーミッション設定で事前承認しておくと中断が減ります。

### チームメイトがエラーで停止する

チームメイトの出力を `Shift+Up/Down`（in-process）またはペインクリック（split panes）で確認し、追加指示を送るか、代替チームメイトを生成します。

### リードが作業完了前にシャットダウンする

リードがすべてのタスク完了前に終了を判断する場合は、続行を指示します。リードが自分で実装を始める場合は、デリゲートモードの使用を検討します。

### 残留する tmux セッション

チーム終了後に tmux セッションが残った場合：

```bash
tmux ls
tmux kill-session -t <session-name>
```

## 制限事項

- **In-process チームメイトのセッション再開不可**: `/resume` や `/rewind` では in-process チームメイトが復元されない。セッション再開後は新しいチームメイトを生成する必要がある
- **タスク状態のラグ**: チームメイトがタスク完了を報告しないことがあり、依存タスクがブロックされる場合がある。手動でタスク状態を更新するか、リードに催促を指示する
- **シャットダウンの遅延**: チームメイトは現在のリクエストやツール呼び出しが完了してから停止するため、時間がかかる場合がある
- **1 セッションにつき 1 チーム**: 新しいチームを開始する前に現在のチームをクリーンアップする必要がある
- **ネスト不可**: チームメイトは独自のチームやチームメイトを生成できない。チーム管理はリードのみ
- **リード固定**: チームを作成したセッションが永続的にリードとなり、リーダーシップの移譲はできない
- **パーミッション**: チームメイトはスポーン時のリードのパーミッションを継承する。スポーン後に個別変更は可能だが、スポーン時に個別設定はできない
- **Split panes の環境要件**: tmux または iTerm2 が必要。VS Code 統合ターミナル、Windows Terminal、Ghostty では非対応
- **トークンコスト**: 各チームメイトが独立した Claude インスタンスであるため、単一セッションより大幅にトークン消費が増加する

## まとめ

- エージェントチームは複数の Claude Code セッションを協調させる**実験的機能**
- サブエージェントとの違いは**チームメイト同士が直接通信できる**こと
- 有効化には `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` 環境変数の設定が必要
- **リサーチ・レビュー・並列開発・デバッグ**に特に効果的
- ファイル競合の回避、適切なタスク粒度、定期的なモニタリングが重要
- トークンコストが増加するため、ルーチン作業には単一セッションの方が効率的

## 参考リンク

### Anthropic 公式ドキュメント

- [Agent Teams](https://docs.anthropic.com/en/docs/claude-code/agent-teams): エージェントチームの公式ドキュメント
- [Subagents](https://docs.anthropic.com/en/docs/claude-code/sub-agents): サブエージェントの公式ドキュメント
- [Hooks](https://docs.anthropic.com/en/docs/claude-code/hooks): フック機能の公式ドキュメント
- [Costs](https://docs.anthropic.com/en/docs/claude-code/costs): コスト管理の公式ドキュメント
- [Features Overview](https://docs.anthropic.com/en/docs/claude-code/features-overview): Claude Code 機能概要
